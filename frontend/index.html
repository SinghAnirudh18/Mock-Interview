<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Interview Assistant</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #60a5fa 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1000px;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 90vh;
            max-height: 850px;
        }

        .header {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            padding: 24px 32px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .header h1 {
            font-size: 26px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .end-interview-btn {
            background: rgba(239, 68, 68, 0.9);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .end-interview-btn:hover {
            background: rgba(220, 38, 38, 1);
            transform: translateY(-2px);
        }

        .end-interview-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .interview-info {
            display: flex;
            gap: 24px;
            align-items: center;
            font-size: 14px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.15);
            padding: 8px 16px;
            border-radius: 8px;
        }

        .phase-indicator {
            background: white;
            color: #1e40af;
            padding: 4px 12px;
            border-radius: 6px;
            font-weight: 600;
            text-transform: capitalize;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 12px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #34d399 100%);
            transition: width 0.5s ease;
            border-radius: 3px;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px 32px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            display: flex;
            gap: 12px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 70%;
            padding: 14px 18px;
            border-radius: 16px;
            font-size: 15px;
            line-height: 1.5;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.interviewer .message-content {
            background: #f3f4f6;
            color: #1f2937;
            border-bottom-left-radius: 4px;
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .message.user .avatar {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .message.interviewer .avatar {
            background: #e5e7eb;
        }

        .controls {
            padding: 24px 32px;
            background: white;
            border-top: 1px solid #e5e7eb;
        }

        .record-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .record-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
        }

        .record-btn.recording {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }

            50% {
                box-shadow: 0 0 0 15px rgba(239, 68, 68, 0);
            }
        }

        .record-btn.processing {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            cursor: not-allowed;
        }

        .record-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .status {
            text-align: center;
            margin-top: 12px;
            font-size: 14px;
            color: #6b7280;
            min-height: 20px;
        }

        .start-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
        }

        .start-icon {
            font-size: 80px;
            margin-bottom: 24px;
        }

        .start-screen h2 {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 12px;
        }

        .start-screen p {
            font-size: 16px;
            color: #6b7280;
            margin-bottom: 32px;
        }

        .job-role-input {
            width: 100%;
            max-width: 400px;
            padding: 14px 18px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 15px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .job-role-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .start-btn {
            padding: 16px 48px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
        }

        .report-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .report-modal.active {
            display: flex;
        }

        .report-content {
            background: white;
            border-radius: 24px;
            padding: 32px;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            width: 100%;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #e5e7eb;
        }

        .report-header h2 {
            font-size: 24px;
            color: #1f2937;
        }

        .close-report {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .score-card {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 24px;
            text-align: center;
        }

        .score-value {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .recommendation {
            font-size: 20px;
            font-weight: 600;
            margin-top: 8px;
        }

        .report-section {
            margin-bottom: 24px;
        }

        .report-section h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 12px;
        }

        .phase-score {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background: #f3f4f6;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .skill-tag {
            display: inline-block;
            background: #dbeafe;
            color: #1e40af;
            padding: 6px 12px;
            border-radius: 6px;
            margin: 4px;
            font-size: 14px;
        }

        .qa-item {
            background: #f9fafb;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            border-left: 4px solid #3b82f6;
        }

        .qa-question {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .qa-answer {
            color: #4b5563;
            margin-bottom: 8px;
        }

        .qa-score {
            display: inline-block;
            background: #10b981;
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        /* Scrollbar styling */
        .chat-container::-webkit-scrollbar,
        .report-content::-webkit-scrollbar {
            width: 8px;
        }

        .chat-container::-webkit-scrollbar-track,
        .report-content::-webkit-scrollbar-track {
            background: #f3f4f6;
            border-radius: 4px;
        }

        .chat-container::-webkit-scrollbar-thumb,
        .report-content::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 4px;
        }

        .chat-container::-webkit-scrollbar-thumb:hover,
        .report-content::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        /* Text Input Styles */
        .text-input-container {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .text-input {
            flex: 1;
            padding: 14px 18px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
        }

        .text-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .text-input:disabled {
            background: #f3f4f6;
            cursor: not-allowed;
        }

        .send-btn {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .send-btn.processing {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .input-divider {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 8px 0;
            color: #9ca3af;
            font-size: 12px;
        }

        .input-divider::before,
        .input-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #e5e7eb;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <h1>
                    <span>üéØ</span>
                    AI Interview Assistant
                </h1>
                <button class="end-interview-btn" id="endBtn" disabled>End Interview & Get Report</button>
            </div>
            <div class="interview-info" id="interviewInfo" style="display: none;">
                <div class="info-item">
                    <span>üìã</span>
                    <span id="jobRole">Software Engineer</span>
                </div>
                <div class="info-item">
                    <span>Phase:</span>
                    <span class="phase-indicator" id="phaseIndicator">greeting</span>
                </div>
                <div class="info-item">
                    <span>Question:</span>
                    <span id="questionCounter">0/17</span>
                </div>
            </div>
            <div class="progress-bar" id="progressBar" style="display: none;">
                <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
            </div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="start-screen" id="startScreen">
                <div class="start-icon">üíº</div>
                <h2>Welcome to AI Interview</h2>
                <p>Prepare for your next job interview with our AI-powered interviewer</p>
                <input type="text" class="job-role-input" id="jobRoleInput"
                    placeholder="Enter job role (e.g., Software Engineer)" value="Software Engineer">
                <button class="start-btn" id="startBtn">Start Interview</button>
            </div>
        </div>

        <div class="controls" id="controls" style="display: none;">
            <!-- Text Input Section -->
            <div class="text-input-container">
                <input type="text" class="text-input" id="textInput" placeholder="Type your response here..." />
                <button class="send-btn" id="sendBtn" title="Send">
                    <span>‚û§</span>
                </button>
            </div>

            <div class="input-divider">
                <span>or use voice</span>
            </div>

            <!-- Voice Recording Button -->
            <button class="record-btn" id="recordBtn">
                <span id="btnIcon">üéôÔ∏è</span>
                <span id="btnText">Start Recording</span>
            </button>
            <div class="status" id="status"></div>
        </div>
    </div>

    <!-- Report Modal -->
    <div class="report-modal" id="reportModal">
        <div class="report-content" id="reportContent">
            <!-- Report will be dynamically inserted here -->
        </div>
    </div>

    <script>
        let recorder;
        let chunks = [];
        let interviewStarted = false;

        const startScreen = document.getElementById("startScreen");
        const chatContainer = document.getElementById("chatContainer");
        const controls = document.getElementById("controls");
        const interviewInfo = document.getElementById("interviewInfo");
        const progressBar = document.getElementById("progressBar");
        const startBtn = document.getElementById("startBtn");
        const endBtn = document.getElementById("endBtn");
        const recordBtn = document.getElementById("recordBtn");
        const btnIcon = document.getElementById("btnIcon");
        const btnText = document.getElementById("btnText");
        const status = document.getElementById("status");
        const jobRoleInput = document.getElementById("jobRoleInput");
        const reportModal = document.getElementById("reportModal");
        const textInput = document.getElementById("textInput");
        const sendBtn = document.getElementById("sendBtn");

        // Send text response function
        async function sendTextResponse() {
            const text = textInput.value.trim();
            if (!text) return;

            // Disable inputs while processing
            textInput.disabled = true;
            sendBtn.disabled = true;
            sendBtn.classList.add("processing");
            recordBtn.disabled = true;
            setStatus("Processing your response...");

            try {
                const res = await fetch("http://localhost:8000/text-response", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user_text: text })
                });

                const data = await res.json();

                if (data.error) {
                    setStatus(data.error);
                } else {
                    addMessage(text, "user");
                    addMessage(data.interviewer_message, "interviewer");
                    updatePhaseUI(data.phase, data.questions_asked || 1, 17);
                    textInput.value = "";
                    setStatus("");

                    if (data.interview_ended) {
                        endBtn.click(); // Trigger end interview flow
                    }
                }
            } catch (error) {
                setStatus("Error: " + error.message);
            }

            // Re-enable inputs
            textInput.disabled = false;
            sendBtn.disabled = false;
            sendBtn.classList.remove("processing");
            recordBtn.disabled = false;
            textInput.focus();
        }

        // Send button click handler
        sendBtn.onclick = sendTextResponse;

        // Enter key handler for text input
        textInput.onkeypress = (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendTextResponse();
            }
        };

        // Start Interview
        startBtn.onclick = async () => {
            const jobRole = jobRoleInput.value.trim() || "Software Engineer";

            try {
                setStatus("Starting interview...");
                const res = await fetch("http://localhost:8000/start-interview", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ job_role: jobRole })
                });

                const data = await res.json();

                // Hide start screen, show interview UI
                startScreen.style.display = "none";
                controls.style.display = "block";
                interviewInfo.style.display = "flex";
                progressBar.style.display = "block";
                endBtn.disabled = false;

                // Update UI
                document.getElementById("jobRole").textContent = jobRole;
                updatePhaseUI(data.phase, 1, 17);

                // Add interviewer's greeting
                addMessage(data.interviewer_message, "interviewer");

                interviewStarted = true;
                setStatus("");
            } catch (error) {
                setStatus("Error starting interview: " + error.message);
            }
        };

        // End Interview
        endBtn.onclick = async () => {
            if (!confirm("Are you sure you want to end the interview?")) return;

            try {
                await fetch("http://localhost:8000/end-interview", { method: "POST" });

                // Get report
                const reportRes = await fetch("http://localhost:8000/interview-report");
                const report = await reportRes.json();

                displayReport(report);

                recordBtn.disabled = true;
                endBtn.disabled = true;
            } catch (error) {
                setStatus("Error ending interview: " + error.message);
            }
        };

        // Recording functionality
        recordBtn.onclick = async () => {
            if (!recorder || recorder.state === "inactive") {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    recorder = new MediaRecorder(stream);

                    recorder.ondataavailable = e => chunks.push(e.data);

                    recorder.onstop = async () => {
                        recordBtn.classList.remove("recording");
                        recordBtn.classList.add("processing");
                        btnIcon.textContent = "‚è≥";
                        btnText.textContent = "Processing...";
                        setStatus("Transcribing and analyzing your response...");

                        const blob = new Blob(chunks, { type: "audio/wav" });
                        chunks = [];

                        const formData = new FormData();
                        formData.append("file", blob, "voice.wav");

                        try {
                            const res = await fetch("http://localhost:8000/interview-response", {
                                method: "POST",
                                body: formData
                            });

                            const data = await res.json();

                            if (data.error) {
                                setStatus(data.error);
                            } else {
                                addMessage(data.transcript, "user");
                                addMessage(data.interviewer_message, "interviewer");
                                updatePhaseUI(data.phase, data.question_number, data.total_questions);
                                setStatus("");
                            }
                        } catch (error) {
                            setStatus("Error: " + error.message);
                        }

                        recordBtn.classList.remove("processing");
                        btnIcon.textContent = "üéôÔ∏è";
                        btnText.textContent = "Start Recording";
                    };

                    recorder.start();
                    recordBtn.classList.add("recording");
                    btnIcon.textContent = "‚èπÔ∏è";
                    btnText.textContent = "Stop Recording";
                    setStatus("Recording... Speak now");
                } catch (error) {
                    setStatus("Error: Could not access microphone");
                }
            } else {
                recorder.stop();
                recorder.stream.getTracks().forEach(track => track.stop());
            }
        };

        function addMessage(text, type) {
            const messageDiv = document.createElement("div");
            messageDiv.className = `message ${type}`;

            const avatar = document.createElement("div");
            avatar.className = "avatar";
            avatar.textContent = type === "user" ? "üë§" : "ü§ñ";

            const content = document.createElement("div");
            content.className = "message-content";
            content.textContent = text;

            if (type === "user") {
                messageDiv.appendChild(content);
                messageDiv.appendChild(avatar);
            } else {
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(content);
            }

            chatContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        function updatePhaseUI(phase, questionNum, totalQuestions) {
            document.getElementById("phaseIndicator").textContent = phase;
            document.getElementById("questionCounter").textContent = `${questionNum}/${totalQuestions}`;

            const progress = (questionNum / totalQuestions) * 100;
            document.getElementById("progressFill").style.width = `${progress}%`;
        }

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function setStatus(message) {
            status.textContent = message;
        }

        function displayReport(report) {
            const content = `
                <div class="report-header">
                    <h2>üìä Interview Report</h2>
                    <button class="close-report" onclick="closeReport()">Close</button>
                </div>

                <div class="score-card">
                    <div class="score-value">${report.scores.overall_score}/10</div>
                    <div>Overall Performance</div>
                    <div class="recommendation">${report.scores.recommendation}</div>
                </div>

                <div class="report-section">
                    <h3>üìà Phase-wise Scores</h3>
                    ${Object.entries(report.scores.phase_scores).map(([phase, score]) => `
                        <div class="phase-score">
                            <span style="text-transform: capitalize;">${phase}</span>
                            <strong>${score}/10</strong>
                        </div>
                    `).join('')}
                </div>

                <div class="report-section">
                    <h3>üí° Skills & Technologies Identified</h3>
                    <div>
                        ${report.memory_extracted.skills_technologies.length > 0
                    ? report.memory_extracted.skills_technologies.map(skill =>
                        `<span class="skill-tag">${skill}</span>`
                    ).join('')
                    : '<p style="color: #6b7280;">No specific technologies mentioned</p>'
                }
                    </div>
                </div>

                <div class="report-section">
                    <h3>üìù Interview Summary</h3>
                    <div class="phase-score">
                        <span>Job Role</span>
                        <strong>${report.candidate_summary.job_role}</strong>
                    </div>
                    <div class="phase-score">
                        <span>Duration</span>
                        <strong>${report.candidate_summary.interview_duration || 'N/A'}</strong>
                    </div>
                    <div class="phase-score">
                        <span>Questions Asked</span>
                        <strong>${report.candidate_summary.total_questions}</strong>
                    </div>
                </div>

                <div class="report-section">
                    <h3>üí¨ Detailed Q&A</h3>
                    ${report.detailed_qa.slice(0, 5).map(qa => `
                        <div class="qa-item">
                            <div class="qa-question">Q: ${qa.question}</div>
                            <div class="qa-answer">A: ${qa.answer}</div>
                            <span class="qa-score">Score: ${qa.score}/10</span>
                            <span class="skill-tag">${qa.phase}</span>
                        </div>
                    `).join('')}
                </div>
            `;

            document.getElementById("reportContent").innerHTML = content;
            reportModal.classList.add("active");
        }

        function closeReport() {
            reportModal.classList.remove("active");

            // Offer to start new interview
            if (confirm("Would you like to start a new interview?")) {
                location.reload();
            }
        }

        // Close modal on outside click
        reportModal.onclick = (e) => {
            if (e.target === reportModal) {
                closeReport();
            }
        };
    </script>
</body>

</html>